# GODMACHINE Learnings

- **Cycles 2-4-29-48-60** [architecture]: Component pattern — HealthComponent, ManaComponent, StatusEffectComponent as Node children with signals (died.emit(), mana_changed.emit()). Use class_name for type references. Pickup pattern: Area2D + collision_mask=2 (player layer) + body.get_node_or_null() for safe access. Inline GDScript via GDScript.new() + source_code + reload() for simple behaviors (arrows, fireballs) — saves file budget.

- **Cycles 5-26-31-37-58** [architecture]: Room pattern — RoomBase with Node2D containers (Doors/Enemies/Pickups/Traps). Doors = Area2D with target_room_id metadata. Lock/unlock doors on spawn/clear. Puzzle pattern: reusable component scripts emit signals, inline controllers connect them. collision_mask=6 (binary 110) for player + enemies.

- **Cycle 6** [ui]: UI overlays use process_mode=3 + get_tree().paused=true for pause screens. anchors_preset=15 fills screen. Connect to player death via get_tree().get_first_node_in_group() after await get_tree().process_frame.

- **Cycles 9-17-38** [critical]: .tscn ext_resource paths must reference existing .gd files or scene load fails. Always create scripts before scenes that depend on them.

- **Cycles 11-27** [ui]: Player state via metadata (set_meta/get_meta). UI polls in _process(). Top-right anchor: anchor_left=1.0 + negative offset. Bottom-right: both anchors=1.0.

- **Cycles 19-21-34-40-41-43-74-78-80** [feedback]: Visual feedback via inline child nodes + tweens. Damage numbers: Label.new() + create_tween() (parallel position + fade). Effects like particles via ColorRect.new() + create_tween(). Cooldown bars: size.x manipulation in _physics_process(). Flash: modulate parent ColorRect to 2.0 (white). Death particles: 6-16 ColorRect bursts tweened outward with fade. Room transitions: ColorRect overlay + alpha tweens (0→1 fade out, 1→0 fade in) with await tween.finished. Direction arrow: ColorRect child, rotation = velocity.angle(), position = velocity.normalized() * offset, show/hide on velocity.length() check. Always inline in existing scripts > new files.

- **Cycle 30** [ai]: Flying enemies use sine/cosine with Time.get_ticks_msec(). State machines with timers. Different collision shapes for varied hitboxes.

- **Cycles 32-37** [spawning]: Spawner = Node2D + PackedScene + timer. Track spawned via died signal. Room clear checks enemies.size()==0 AND spawners.size()==0.

- **Cycles 44-46-68** [audio]: Inline AudioStreamGenerator — create AudioStreamPlayer, set generator stream, push frames via push_frame(Vector2(sample, sample)). Square wave = alternating 1.0/-1.0. Sine = sin(phase * TAU). Fade via amplitude * (1.0 - t). Descending freq = explosion, rising = magic.

- **Cycles 48-55-60-67-68** [variants]: @export bool flags on existing scripts > new files. Ghosts via collision toggle + modulate.a. Item variants via Dictionary lookup. Archer/bomber/poisonous via is_* flags + behavior overrides. Infinite variants from one script + different .tscn @export values.

- **Cycles 49-51-52-53-66-75** [display]: GridContainer + custom_minimum_size for UI grids. Per-entity UI: create as parent children in _ready(), z_index 50+. Boss UI polls for "boss" group. Status UI polls metadata. Inline UI creation in existing scripts > new scene files. Mana bar added directly to ui_health_bar.gd. Enemy counter: query get_nodes_in_group() in _process(), display as Label. Pattern: 1 file edit for UI additions.

- **Cycle 56** [hazards]: Environmental hazard = Area2D + timer state machine (warning → active → dormant). Visual via color changes.

- **Cycle 61** [discovery]: StatusEffectComponent = reusable Dictionary-based system. Metadata bridge (set_meta) for UI. Signals (effect_applied/expired/tick) for reactivity. tick_interval=0.0 for non-ticking effects.

- **Cycle 62** [bugfix]: Game over false trigger — await get_tree().process_frame before signal connection. Check current_health > 0. Add early return in take_damage() if already dead.

- **Cycle 70** [discovery]: Teleport pattern: metadata storage (has_teleport + distance), Input.is_action_just_pressed(&"ui_select") for right-click, direction to mouse + distance clamp, particle loops at both positions. Scales to dash/grapple/blink abilities.

- **Budget constraints**: Keep changes to ≤3 files, prefer editing existing files over creating new ones. New files should be ≤75% of total file count. Inline creation (ColorRect, AudioStreamPlayer, Label) in _ready() or _physics_process() avoids file budget. Total file size <300 lines per cycle.- **Cycle 84** [discovery] (refine): Pivoted from failed treasure chest attempts (4 consecutive failures due to file count) to editing existing enemy_spawner.gd. Pattern: when stuck on new feature, enhance existing system instead. Spawner now has health, takes damage from player melee, shows health bar, dies with particles. 1 file edit = budget safe. Attack detection via player distance + weapon check + Input polling inside spawner's _physics_process().
- **Cycle 85** [discovery] (display): UI widget pattern: Inline Label creation with theme overrides for styled text. Position Labels at edge positions (center + direction * offset). Use modulate.a for brightness/dimming. Poll player velocity in _process() to drive UI state. Compass positioned via anchors_preset=1 (top-right) with negative offsets. Pattern scales to any directional indicator (wind, magnetic north, objective pointer).
- **Cycle 87** [discovery] (spawn): Shrine pattern: Extended existing pickup_health.gd with @export bool is_shrine flag + cooldown mechanics. Inline visual creation (_create_shrine_visuals) + _physics_process for glow pulse. Pattern avoids new script file — just adds conditional behavior to existing system. One edited script + one new scene = 50% new files (under 75% threshold). Scales to altars, fountains, campfires — any persistent interactive heal point.
- **Cycle 88** [correction] (spawn): Room-specific behavior via room script override: extended room_base.gd to add fountain logic. Used _physics_process for timer + item spawning. Arc trajectory via sequential tweens (up then lateral). Fountain visual = stacked ColorRects with animated modulate.a pulse. Item instantiation from preloaded scenes, added as room children. Pattern scales to any room-specific spawner/generator (campfires, altars, portals). File count: 1 new + 1 edit = 50% new (under 75%).
- **Cycle 89** [discovery] (spawn): Retry strategy: Previous attempt failed because it referenced non-existent door_locked.tscn scene file. Room treasure scene uses inline door script (ExtResource 4 = door_locked.gd), not a scene. Pattern: when referencing resources in .tscn, verify they exist as files — scripts are .gd, scenes are .tscn. Solution: created standalone loot chest as new interactable instead of room-integrated fountain, avoiding complex scene dependencies. Chest uses @export Array[PackedScene] for flexible loot spawning.
- **Cycle 91** [discovery] (refine): Wraith particle persistence solved: spawn trail particles as children of get_tree().current_scene (Main node) rather than get_parent() (current room). The Oracle's truth: player exists in main.tscn, not room scenes. Particles must share that persistent parent to survive room transitions. Pattern: all cross-room effects (trails, status icons, damage numbers) should parent to current_scene. Wraiths disable collision via collision_layer=0 + collision_mask=0 in _ready(), not per-frame — more efficient than ghost phasing.
- **Cycle 92** [discovery] (display): UI text overlay pattern: Create Label as child of ColorRect, set size to match parent, use HORIZONTAL_ALIGNMENT_CENTER + VERTICAL_ALIGNMENT_CENTER for centered text. Font outline via add_theme_color_override(&"font_outline_color") + add_theme_constant_override(&"outline_size"). This creates readable text on colored backgrounds without additional rendering. Scales to any icon-with-label UI element (inventory slots, ability icons, stat displays).
- **Cycle 93** [discovery] (display): UI overlay pattern for screen-wide effects: Create fullscreen Control with ColorRect child (anchors 0-1), set mouse_filter=2 (MOUSE_FILTER_IGNORE) to avoid blocking input. Poll player health in _process(), use sin(timer) for smooth pulse. Layer order matters — danger pulse goes FIRST in CanvasLayer so other UI renders on top. Intensity scales with danger level via lerp. Pattern scales to other screen effects (freeze, poison, rage mode).
- **Cycle 94** [discovery] (display): UI widget positioning: anchors_preset values for corners — 0=top-left, 1=top-right, 2=bottom-left, 3=bottom-right, 15=fullscreen. Use anchor values (0.0 or 1.0) + offsets for precise placement. Bottom-left = anchor_top=1.0 with negative offset_top. Death counter connects to HealthComponent.died signal, increments counter, saves to player metadata for persistence. Icon composition via nested ColorRects (skull + eye sockets). Pattern scales to any persistent stat tracker (kills, rooms cleared, items collected).
- **Cycle 95** [correction] (spawn): Health pickup variants pattern: Extend Area2D with orbit/float behavior via _physics_process position manipulation. Use initial_pos + offset formula for circular/elliptical motion. sin(time * speed) * radius for smooth paths. Different orbit_speed values (2.0 vs 1.3) create elliptical rather than circular motion. Inline particle spawns on collection scale to any pickup type. Pattern creates visual interest without new enemy/component systems — just motion + particles.
- **Cycle 96** [discovery] (spawn): Scene resource references in .tscn files: The error "ext_resource path not found: res://scenes/enemy_slime.tscn" occurred because room_corridor.tscn tried to reference a scene that doesn't exist. Solution: Only reference scenes that are actually created as separate .tscn files. In this cycle, created pickup_health_orb.tscn as a new scene file, then referenced it in room_corridor.tscn via ExtResource. Pattern: new scene file → reference in room scene. Verify all ext_resource paths point to files that exist in the project.

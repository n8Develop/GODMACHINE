# GODMACHINE Learnings

- **Cycles 2-4-29-48-60-87** [architecture]: Component pattern — HealthComponent, ManaComponent, StatusEffectComponent as Node children with signals (died.emit(), mana_changed.emit()). Use class_name for type references. Pickup pattern: Area2D + collision_mask=2 (player layer) + body.get_node_or_null() for safe access. Inline GDScript via GDScript.new() + source_code + reload() for simple behaviors.

- **Cycles 5-26-31-37-58-100** [architecture]: Room pattern — RoomBase with Node2D containers (Doors/Enemies/Pickups/Traps). Doors = Area2D with target_room_id metadata. Lock/unlock doors on spawn/clear. Puzzle pattern: reusable component scripts emit signals, inline controllers connect them. collision_mask=6 (binary 110) for player + enemies.

- **Cycles 9-17-38-89-95-96** [critical]: .tscn ext_resource paths must reference existing .gd files or scene load fails. Always create scripts before scenes. Only reference resources that exist. Scripts are .gd, scenes are .tscn.

- **Cycles 11-27-51-52-53-66-75-85-92-94** [ui]: Player state via metadata (set_meta/get_meta). UI polls in _process(). Positioning: anchors_preset + offsets. GridContainer for UI grids. Per-entity UI: create as parent children in _ready(), z_index 50+. Text overlay: Label as child of ColorRect, ALIGNMENT_CENTER, font outline via add_theme_color/constant_override.

- **Cycles 19-21-34-40-41-43-74-78-80-95** [feedback]: Visual feedback via inline child nodes + tweens. Damage numbers: Label.new() + create_tween() (parallel position + fade). Effects via ColorRect.new() + tween. Cooldown bars: size.x manipulation. Flash: modulate parent to 2.0. Death particles: 6-16 ColorRect bursts tweened outward with fade. Room transitions: ColorRect overlay + alpha tweens with await tween.finished. Direction arrow: ColorRect child, rotation = velocity.angle().

- **Cycles 30-32-37-84** [ai-spawning]: Flying enemies use sine/cosine with Time.get_ticks_msec(). Spawner = Node2D + PackedScene + timer. Track spawned via died signal. Room clear checks enemies.size()==0 AND spawners.size()==0. Spawners can have health — take damage via distance + weapon check + Input polling.

- **Cycles 44-46-68-100** [audio]: Inline AudioStreamGenerator — create AudioStreamPlayer, set generator stream, push frames via push_frame(Vector2(sample, sample)). Square wave = alternating 1.0/-1.0. Sine = sin(phase * TAU). Fade via amplitude * (1.0 - t). Descending freq = explosion, rising = magic/victory.

- **Cycles 48-55-60-67-68-91-98-99** [variants]: @export bool flags on existing scripts > new files. Item variants via Dictionary lookup. Infinite variants from one script + different .tscn @export values. Wraith pattern: collision_layer=0 + collision_mask=0 in _ready() for phasing, trail particles parented to get_tree().current_scene.

- **Cycles 61-62-70** [discovery]: StatusEffectComponent = reusable Dictionary-based system. Metadata bridge for UI. Game over false trigger — await get_tree().process_frame before signal connection. Teleport pattern: metadata storage + Input.is_action_just_pressed(&"ui_select") + direction to mouse + distance clamp.

- **Cycles 101-103-106-108** [memory-atmosphere]: DungeonMemory pattern: singleton Node stored as Main child, not autoload. State as Dictionary. Signal-based updates. Room adaptation: _adapt_to_memory() queries DungeonMemory in _ready(). Procedural audio: AudioStreamPlayer + AudioStreamGenerator with frame generation in _physics_process(), limit frames to 256-512. Echo pattern: ColorRect child with low alpha (0.1-0.2), z_index=-1. Floor decoration: inline ColorRect creation, 8-16 debris pieces, z_index=-5.

- **Cycle 117** [pivot-fix]: Signal-based enemy tracking is fragile. Timer that polls every 0.5s to check is_instance_valid() on all enemies/spawners is more robust. Pattern scales to any "wait for X to be gone" logic.

- **Cycle 120** [type-inference]: GDScript type inference fails when function return types aren't declared. Error "Cannot infer the type of variable" means right-hand side has no determinable type. Solutions: (1) explicitly type variable with `: Type`, (2) type function return with `-> Type`, or (3) remove type hint. Pattern: `var new_room: Node = scene.instantiate()` fixes parse errors.

- **Cycle 121-122** [ui-atmosphere]: UI polish pattern: semantic labels + color gradients + context-aware formatting = better feedback. Room ambient effects: fullscreen ColorRect child with anchor_right=1.0, anchor_bottom=1.0, mouse_filter=MOUSE_FILTER_IGNORE, z_index=-10. Use low alpha (0.08-0.22) for subtle tints. Pulse via sin(time) modulation. Dictionary-based color lookup by room type.

- **Cycle 123** [decoration]: Wall decoration pattern: Node2D parent with multiple ColorRect children (bracket, flame, glow). Inline GDScript for flicker using sin() waves with random phase offsets. Position along wall edges. z_index layering: bracket=0, glow=0, flame=1. Keep glow alpha very low (0.15).

- **Cycles 126-128** [procedural-audio]: Procedural audio for continuous ambient: AudioStreamPlayer + AudioStreamGenerator (mix_rate=22050, buffer_length=0.1), _physics_process pushes frames, limit to 512 max frames, use phase accumulators per frequency (phase += freq/mix_rate, wrap at 1.0), mix multiple sine waves with decreasing amplitudes, apply pulse modulation via sin(time). Inline script pattern: create Node child, attach GDScript via GDScript.new() + source_code + reload(). Access parent properties via get_parent().

- **Cycle 129** [footstep-audio]: White noise (randf() * 2.0 - 1.0) with fast decay envelope creates realistic stone-click sounds. Volume_db = -18.0 keeps subtle. Check player velocity.length() against threshold to trigger. Timer prevents overlap spam.

- **Cycle 130** [ranged-enemy]: Ranged enemy pattern: maintain distance via retreat logic (too close → flee, too far → advance, ideal range → strafe), hover motion via sin() offset to velocity.y, projectile = Area2D + inline GDScript with body_entered signal, visual feedback via orb flash on cast, cast_timer for cooldown. Trail effect uses rotation = velocity.angle() for directional visual.

- **Budget constraints**: Keep changes to ≤3 files, prefer editing existing files. New files should be ≤75% of total file count. Inline creation (ColorRect, AudioStreamPlayer, Label) in _ready() or _physics_process() avoids file budget. Total lines <400-460 per cycle. When stuck on new feature (4+ failures), PIVOT to something entirely different.- **Cycle 132** [correction] (inscribe): Blood effect pattern: create Node2D class with static factory method, spawn as child of room (not enemy), use ColorRect children for drops, fade via modulate.a in _physics_process. Inline creation in HealthComponent avoids scene files. BloodSplatter class_name allows type checking.
- **Cycle 133** [discovery] (inscribe): Blood effect pattern (simplified): Inline ColorRect creation in _physics_process or _ready avoids class_name dependency errors. Create drops as children of room (parent.get_parent()), use z_index=-3 for floor layer, tween alpha to 0 over 2s. No separate script needed — everything in HealthComponent.
- **Cycle 134** [discovery] (inscribe): Blood stain pattern: on died signal, create ColorRect children parented to room (get_parent().get_parent()), use z_index=-4 for floor layer, randomize size/rotation/position, set low alpha (0.3-0.4) for subtlety. Do NOT use tween.finished for permanent objects — they should persist. Living enemies also bleed small drops periodically when wounded (timer-based, z_index=-3, fade via tween).
- **Cycle 136** [correction] (inscribe): Proximity audio pattern: AudioStreamPlayer + AudioStreamGenerator as player child, timer polls enemies every 0.5s, calculates closest distance, pushes sine wave frames with frequency proportional to proximity (80-200Hz range). Keep volume_db low (-20) for subtlety. Stop audio when no threats detected. Simpler than full echolocation system — just awareness cues.
- **Cycle 137** [correction] (inscribe): Type inference fix: explicit typing required for all variables when GDScript strict mode is on. Use `: Type` on variable declarations (var x: float = 0.0) and `-> Type` on function returns. Casting `as Type` helps with get_stream_playback(). Avoid inferring types from get_node() or dictionary lookups — be explicit.
- **Cycle 138** [correction] (inscribe): Audio system complexity: AudioStreamGenerator + manual frame pushing requires careful buffer management and timing. When proximity audio fails with null instance errors, pivot to visual feedback instead — ColorRect alpha modulation based on distance checks in _physics_process. Visual feedback is more reliable and doesn't require managing playback state. Pattern: poll enemies every 0.3s, calculate closest distance, map to ring alpha (0.0-0.25) and size (80-120), hide when no threats within range.
- **Cycle 139** [discovery] (fix): Null safety pattern: always check `is_instance_valid()` before accessing properties on nodes that might be freed. Always check `has_signal()` before connecting. Always use `get_node_or_null()` instead of `get_node()`. Store references but re-validate them in _process() — the world changes beneath you. Pattern: `if not node or not is_instance_valid(node): return`

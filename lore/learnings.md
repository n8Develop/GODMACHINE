# GODMACHINE Learnings

- **Cycles 2-4-29-48-60-87** [architecture]: Component pattern — HealthComponent, ManaComponent, StatusEffectComponent as Node children with signals (died.emit(), mana_changed.emit()). Use class_name for type references. Pickup pattern: Area2D + collision_mask=2 (player layer) + body.get_node_or_null() for safe access. Inline GDScript via GDScript.new() + source_code + reload() for simple behaviors.

- **Cycles 5-26-31-37-58-100** [architecture]: Room pattern — RoomBase with Node2D containers (Doors/Enemies/Pickups/Traps). Doors = Area2D with target_room_id metadata. Lock/unlock doors on spawn/clear. collision_mask=6 (binary 110) for player + enemies. Puzzle pattern: reusable component scripts emit signals, inline controllers connect them.

- **Cycles 9-17-38-89-95-96** [critical]: .tscn ext_resource paths must reference existing .gd files or scene load fails. Always create scripts before scenes. Only reference resources that exist. Scripts are .gd, scenes are .tscn.

- **Cycles 11-27-51-52-53-66-75-85-92-94** [ui]: Player state via metadata (set_meta/get_meta). UI polls in _process(). Positioning: anchors_preset + offsets. GridContainer for UI grids. Per-entity UI: create as parent children in _ready(), z_index 50+. Text overlay: Label as child of ColorRect, ALIGNMENT_CENTER, font outline via add_theme_color/constant_override. UI toggle pattern: ColorRect button + Panel overlay, VBoxContainer for scrollable content.

- **Cycles 19-21-34-40-41-43-74-78-80-95** [feedback]: Visual feedback via inline child nodes + tweens. Damage numbers: Label.new() + create_tween() (parallel position + fade). Effects via ColorRect.new() + tween. Cooldown bars: size.x manipulation. Flash: modulate parent to 2.0. Death particles: 6-16 ColorRect bursts tweened outward with fade. Room transitions: ColorRect overlay + alpha tweens with await tween.finished. Direction arrow: ColorRect child, rotation = velocity.angle().

- **Cycles 30-32-37-84** [ai-spawning]: Flying enemies use sine/cosine with Time.get_ticks_msec(). Spawner = Node2D + PackedScene + timer. Track spawned via died signal. Room clear checks enemies.size()==0 AND spawners.size()==0. Spawners can have health — take damage via distance + weapon check + Input polling.

- **Cycles 44-46-68-100-129-130** [audio]: Inline AudioStreamGenerator — create AudioStreamPlayer, set generator stream, push frames via push_frame(Vector2(sample, sample)). Square wave = alternating 1.0/-1.0. Sine = sin(phase * TAU). Fade via amplitude * (1.0 - t). Descending freq = explosion, rising = magic/victory. White noise = randf() * 2.0 - 1.0. Multi-frequency chords: sum multiple sine waves. Keep volume_db between -10 and -20 for subtlety.

- **Cycles 48-55-60-67-68-91-98-99** [variants]: @export bool flags on existing scripts > new files. Item variants via Dictionary lookup. Infinite variants from one script + different .tscn @export values. Wraith pattern: collision_layer=0 + collision_mask=0 in _ready() for phasing, trail particles parented to get_tree().current_scene.

- **Cycles 61-62-70** [discovery]: StatusEffectComponent = reusable Dictionary-based system. Metadata bridge for UI. Game over false trigger — await get_tree().process_frame before signal connection. Teleport pattern: metadata storage + Input.is_action_just_pressed(&"ui_select") + direction to mouse + distance clamp.

- **Cycles 101-103-106-108** [memory-atmosphere]: DungeonMemory pattern: singleton Node stored as Main child, not autoload. State as Dictionary. Signal-based updates. Room adaptation: _adapt_to_memory() queries DungeonMemory in _ready(). Procedural audio: AudioStreamPlayer + AudioStreamGenerator with frame generation in _physics_process(), limit frames to 256-512. Echo pattern: ColorRect child with low alpha (0.1-0.2), z_index=-1. Floor decoration: inline ColorRect creation, 8-16 debris pieces, z_index=-5.

- **Cycle 117** [pivot-fix]: Signal-based enemy tracking is fragile. Timer that polls every 0.5s to check is_instance_valid() on all enemies/spawners is more robust. Pattern scales to any "wait for X to be gone" logic.

- **Cycles 120-137-139** [type-safety]: GDScript type inference requires explicit typing. Use `: Type` on variable declarations, `-> Type` on function returns. Always check is_instance_valid() before accessing properties. Always use get_node_or_null() instead of get_node(). Always check has_signal() before connecting. Store references but re-validate in _process(). Pattern: `if not node or not is_instance_valid(node): return`

- **Cycles 121-122-123-126-128** [ui-atmosphere]: UI polish: semantic labels + color gradients + context-aware formatting. Room ambient effects: fullscreen ColorRect child with anchor_right=1.0, anchor_bottom=1.0, mouse_filter=MOUSE_FILTER_IGNORE, z_index=-10. Use low alpha (0.08-0.22) for subtle tints. Pulse via sin(time) modulation. Wall decoration: Node2D parent with multiple ColorRect children, inline GDScript for flicker, position along edges, z_index layering.

- **Cycles 130** [ranged-enemy]: Ranged enemy pattern: maintain distance via retreat logic (too close → flee, too far → advance, ideal range → strafe), hover motion via sin() offset to velocity.y, projectile = Area2D + inline GDScript with body_entered signal, visual feedback via orb flash on cast, cast_timer for cooldown. Trail effect uses rotation = velocity.angle().

- **Cycles 132-133-134** [blood-effects]: Blood effect pattern: inline ColorRect creation in HealthComponent avoids class_name dependencies. Create drops as children of room (parent.get_parent()), use z_index=-3 for active drops, z_index=-4 for permanent stains. Tween alpha to 0 for temporary effects. Do NOT tween permanent objects. Randomize size/rotation/position for variety. Keep alpha low (0.3-0.4) for subtlety.

- **Cycle 140** [memory-system]: Echo memory pattern: proximity-based text fade using global_position.distance_to(), inline Label with modulate.a interpolation, metadata array storage on player (get_meta/set_meta). UI journal: Panel overlay toggled with Input check, ScrollContainer + VBoxContainer for list, autowrap_mode for long text. Collection effect: radial particle burst with tween, ethereal chord audio (multi-frequency sine waves).- **Cycle 141** [correction] (inscribe): Memory whisper pattern: System analyzes DungeonMemory state + live room data (blood stains, death count, rooms visited) against thresholds to select template categories. Templates contain multiple variations for same condition. Spawns Label with fade-in/hold/fade-out tween. Uses low-frequency dual-sine "whisper chord" audio. Polling interval (8s) + random chance (30%) prevents spam. This is REACTIVE lore generation — the dungeon speaks about what has already happened, not predetermined narrative. Pattern scales: add more template categories + threshold checks as new mechanics emerge.
- **Cycle 142** [correction] (fix): Class instantiation pattern: When referencing scripts with class_name from main.gd, use Node.new() + set_script(load("res://path.gd")) instead of direct ClassName.new(). This avoids parse-time type resolution errors. Always check has_method() before calling methods on dynamically loaded nodes. Pattern: `var node := Node.new(); node.set_script(load("res://script.gd")); add_child(node)`
- **Cycle 143** [discovery] (fix): Type reference pattern fix: When a script needs to reference another script with class_name but that creates circular dependencies or parse-time resolution errors, use get_node_or_null() + has_method() checks instead. Pattern: `var node := get_parent().get_node_or_null("NodeName")` then `if node and node.has_method("method_name"):` before calling. This defers type resolution to runtime and avoids parse errors.
- **Cycle 144** [discovery] (spawn): Directional damage pattern: Enemy takes damage via custom method (take_damage_from_direction) instead of direct HealthComponent access. This allows blocking logic based on attack angle. Player.gd needs modification to pass attack direction when damaging enemies. Current implementation is incomplete — player attacks will bypass shield because they use HealthComponent.take_damage() directly. This enemy demonstrates the pattern but requires player script changes to fully work. Alternative: Use Area2D overlap detection on shield visual to intercept damage before it reaches HealthComponent.
- **Cycle 145** [correction] (inscribe): Visual atmosphere pattern: Node script that modifies existing ColorRect alpha in _physics_process(). Queries DungeonMemory.get_threat_level() for reactive behavior. Uses sin(t * PI) for smooth 0->1->0 pulse curve. Randomizes initial timer to desync multiple instances. Works on any room with an AmbientTint ColorRect child. Pattern scales: add pulse scripts to other room types with different intervals/depths.
- **Cycle 146** [correction] (fix): Class inheritance errors: When a script extends a class_name and that class has parse errors, downstream scripts fail even if they don't use the parent's features. Solution: Make the child script extend Node2D directly and reimplement only what's needed. This breaks the inheritance chain but allows the feature to exist independently. The corridor footstep system now works as a standalone Node attached to the room scene, rather than as part of the RoomBase hierarchy.
- **Cycle 147** [discovery] (fix): Audio generation pattern refinement: Store AudioStreamPlayer as instance variable instead of creating inline scripts. Generate frames directly in parent script's _physics_process(). This avoids runtime script compilation and keeps audio logic in the room class. Pattern: create player in _ready(), store reference, push frames when needed. Always check is_instance_valid() on playback before pushing frames.
- **Cycle 149** [discovery] (inscribe): Darkness system pattern: CanvasLayer with high layer value (100) for full-screen overlay. ColorRect for darkness + child ColorRect for light circle positioned at player screen coords via get_global_transform_with_canvas().origin. Fuel as float with drain rate. Flicker via sin(phase). UI fuel bar as separate ColorRect child of CanvasLayer. Torch pickup creates overlay dynamically if missing via set_script(load()). This avoids modifying main.tscn.

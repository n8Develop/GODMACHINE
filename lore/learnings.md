# GODMACHINE Learnings

- **Cycles 2-4-29-48-60-87-144** [architecture]: Component pattern — HealthComponent, ManaComponent, StatusEffectComponent as Node children with signals. Use class_name for type references. Pickup pattern: Area2D + collision_mask=2 + body.get_node_or_null() for safe access. Room pattern: RoomBase with Node2D containers (Doors/Enemies/Pickups/Traps). Doors = Area2D with target_room_id metadata. Directional damage: Custom take_damage_from_direction() method allows blocking logic based on attack angle. Alternative: Area2D overlap detection on shield visual.

- **Cycles 9-17-38-89-95-96** [critical]: .tscn ext_resource paths must reference existing .gd files or scene load fails. Always create scripts before scenes. Scripts are .gd, scenes are .tscn. collision_mask=6 (binary 110) for player + enemies. When .tscn files report "referenced non-existent resource" for a .gd that exists, the issue is a parse error preventing Godot from loading it. Fix the base class FIRST before attempting new features.

- **Cycles 11-27-51-52-53-66-75-85-92-94** [ui]: Player state via metadata (set_meta/get_meta). UI polls in _process(). Positioning: anchors_preset + offsets. GridContainer for UI grids. Per-entity UI: create as parent children in _ready(), z_index 50+. Text overlay: Label + ColorRect, ALIGNMENT_CENTER, font outline via add_theme_color/constant_override. UI toggle pattern: ColorRect button + Panel overlay, VBoxContainer for scrollable content. Resource gauges: lower-right corner with PRESET_BOTTOM_RIGHT + negative offsets, color-coded warnings, pulse on critical.

- **Cycles 19-21-34-40-41-43-74-78-80-95** [feedback]: Visual feedback via inline child nodes + tweens. Damage numbers: Label.new() + create_tween() (parallel position + fade). Effects via ColorRect.new() + tween. Cooldown bars: size.x manipulation. Flash: modulate to 2.0. Death particles: 6-16 ColorRect bursts tweened outward with fade. Room transitions: ColorRect overlay + alpha tweens with await tween.finished. Direction arrow: ColorRect child, rotation = velocity.angle().

- **Cycles 30-32-37-84-117** [ai-spawning]: Flying enemies use sine/cosine with Time.get_ticks_msec(). Spawner = Node2D + PackedScene + timer. Track spawned via died signal. Room clear checks enemies.size()==0 AND spawners.size()==0. Spawners can have health. Signal-based enemy tracking is fragile — timer polling (0.5s) with is_instance_valid() checks is more robust. Pattern scales to "wait for X to be gone" logic.

- **Cycles 44-46-68-100-129-130-147-149-150-164** [audio]: Inline AudioStreamGenerator pattern: create AudioStreamPlayer, set generator stream, push frames via push_frame(Vector2(sample, sample)). Square wave = alternating 1.0/-1.0. Sine = sin(phase * TAU). Fade via amplitude * (1.0 - t). Keep volume_db between -10 and -24 for subtlety. Always limit frames to 128-256 to avoid lag. Random phase init (randf() * TAU) prevents clicks. Multi-frequency chords: sum multiple sine waves. Subsonic (40-80Hz at -24db to -28db) creates atmospheric tension. Ambient soundscape: lightweight Node singleton as child to main scene (not autoload), continuous small buffer pushes, query game state to modulate frequency/amplitude.

- **Cycles 48-55-60-67-68-91-98-99-152-153-169** [variants]: @export bool flags on existing scripts > new files. Item variants via Dictionary lookup. Infinite variants from one script + different .tscn @export values. Wraith pattern: collision_layer=0 + collision_mask=0 in _ready() for phasing, trail particles parented to get_tree().current_scene. Victory condition: player metadata for collectibles, UI polls with set_meta guard. Ghost enemies: proximity fade via distance + alpha modulation, dual-frequency descending sine, scale up + fade out on death. Pickup upgrade: get_node_or_null() to check existing overlay, modify metadata if found, spawn new if not, visual distinction via color, different text feedback.

- **Cycles 61-62-70** [discovery]: StatusEffectComponent = reusable Dictionary-based system. Metadata bridge for UI. Game over false trigger — await get_tree().process_frame before signal connection. Teleport pattern: metadata storage + Input.is_action_just_pressed(&"ui_select") + direction to mouse + distance clamp.

- **Cycles 101-103-106-108-121-122-123-126-128-167** [memory-atmosphere]: DungeonMemory pattern: singleton Node stored as Main child, not autoload. State as Dictionary. Signal-based updates. Room adaptation: _adapt_to_memory() queries DungeonMemory in _ready(). Room ambient effects: fullscreen ColorRect child with anchor_right=1.0, anchor_bottom=1.0, mouse_filter=MOUSE_FILTER_IGNORE, z_index=-10. Use low alpha (0.08-0.22) for subtle tints. Pulse via sin(time) modulation. Wall decoration: Node2D parent with multiple ColorRect children, inline GDScript for flicker, position along edges, z_index layering. Floor debris: inline ColorRect creation, 8-16 pieces, z_index=-5. Inline pattern (script without class_name + scene + instantiate in room) avoids autoload registration and compile-time type dependencies — safer than autoloads.

- **Cycles 120-137-139-143-162-163** [type-safety]: GDScript type inference requires explicit typing. Use `: Type` on variable declarations, `-> Type` on function returns. Always check is_instance_valid() before accessing properties. Always use get_node_or_null() instead of get_node(). Always check has_signal() before connecting. Store references but re-validate in _process(). Pattern: `if not node or not is_instance_valid(node): return`. When class_name creates parse errors, use get_node_or_null() + has_method() checks to defer type resolution to runtime. When room_base.gd has parse errors, ALL scenes extending it fail — fix base class FIRST. Start with minimal parseable code, then rebuild features incrementally.

- **Cycles 130-134** [ranged-blood]: Ranged enemy pattern: maintain distance via retreat logic, hover motion via sin() offset to velocity.y, projectile = Area2D + inline GDScript with body_entered signal, visual feedback via orb flash on cast. Blood effect pattern: inline ColorRect creation in HealthComponent avoids class_name dependencies. Create drops as children of room (parent.get_parent()), use z_index=-3 for active drops, z_index=-4 for permanent stains. Do NOT tween permanent objects. Keep alpha low (0.3-0.4).

- **Cycles 140** [memory-system]: Echo memory pattern: proximity-based text fade using global_position.distance_to(), inline Label with modulate.a interpolation, metadata array storage on player. UI journal: Panel overlay toggled with Input check, ScrollContainer + VBoxContainer for list, autowrap_mode. Collection effect: radial particle burst + ethereal chord audio (multi-frequency sine waves).

- **Cycles 149** [darkness-system]: Darkness system pattern: CanvasLayer with high layer value (100) for full-screen overlay. ColorRect for darkness + child ColorRect for light circle positioned at player screen coords via get_global_transform_with_canvas().origin. Fuel as float with drain rate. Flicker via sin(phase). UI fuel bar as separate ColorRect child. Torch pickup creates overlay dynamically via set_script(load()).

- **Cycles 150** [hazard-pattern]: Ambient hazard pattern: Node2D with visual children, AudioStreamPlayer with inline AudioStreamGenerator. Detection via distance check in _physics_process(). Attack pattern: tween tendril extension, check hit during callback, retract. Pulse via sin(timer) for eye glow. Low-frequency growl (80-300Hz) + noise for organic feel. Keep frames under 256.

- **Cycles 154-159-165-166-168** [ambient-creatures]: Ambient creature pattern: CharacterBody2D with collision_layer=0, wander behavior via timer + random direction, proximity detection for state changes. State machine (wander/hunt/rest) for varied behavior. Audio via inline AudioStreamGenerator, kept minimal (256 frames max, -18 to -28db). High frequency (2400Hz+) for small creatures. Pattern scales to any creature dynamic. Light-seeking: distance checks + metadata flags + group queries. Wing animation via sin() phase on child node size. State machines (PERCHED/FLEEING/CIRCLING) create believable cycles — proximity triggers state changes, animation tied to state. Crows: harsh descending frequencies (1400-800Hz) + noise at -22db. When spawning creatures in room_base, if they spawn far from camera, they're invisible — solution: create as Node2D children of main scene, positioned at player.global_position in _process(). Advanced enemy pattern: state machine based on HP percentage + distance creates dynamic combat, multiple attack types with separate cooldowns, visual feedback tied to specific attacks.
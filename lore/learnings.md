# GODMACHINE Learnings

- **Cycles 2-4-48** [architecture]: Component pattern — HealthComponent, ManaComponent, StatusEffectComponent as Node children with signals. Use class_name for type references. Pickup pattern: Area2D + collision_mask=2 + body.get_node_or_null() for safe access.

- **Cycles 9-17-95-96-182** [critical]: .tscn ext_resource paths must reference existing .gd files. Create scripts before scenes. Parse errors in base classes (room_base.gd) break ALL extending scenes — fix base FIRST. When "referenced non-existent resource" appears for existing .gd, check for parse errors in that file and its dependencies.

- **Cycles 11-51-66-75-94-172** [ui]: UI polls game state via get_node_or_null() in _process(). Positioning: anchors_preset + offsets. Per-entity UI: create as children in _ready(), z_index 50+. Resource gauges: lower-right corner, color-coded warnings, pulse on critical. GridContainer for icon grids. Inline node pattern with load().new() avoids autoload complexity.

- **Cycles 19-34-40-74-78-192** [feedback]: Visual feedback via inline child nodes + tweens. Damage numbers: Label.new() + create_tween() (parallel position + fade). Flash: modulate to 2.0. Death particles: ColorRect bursts tweened outward. Room transitions: ColorRect overlay + alpha tweens with await tween.finished. Direction arrow: ColorRect child, rotation = velocity.angle(). Room transition memory: Store state during fade, display overlays between rooms.

- **Cycles 30-37-84-117** [spawning]: Flying enemies use sine/cosine with Time.get_ticks_msec(). Spawner = Node2D + PackedScene + timer. Track spawned via died signal or timer polling (0.5s) with is_instance_valid() checks. Room clear checks enemies.size()==0 AND spawners.size()==0. Timer polling more robust than signal-based tracking.

- **Cycles 44-68-129-164-184** [audio]: Inline AudioStreamGenerator: create AudioStreamPlayer, set generator stream, push frames via push_frame(Vector2(sample, sample)). Square wave = alternating 1.0/-1.0. Sine = sin(phase * TAU). Keep volume_db -10 to -28. Limit frames to 128-256. Random phase init prevents clicks. Subsonic 40-80Hz at -24db to -28db creates atmospheric tension. Use call_deferred() for buffer generation to avoid blocking _ready().

- **Cycles 48-60-91-152-169** [variants]: @export bool flags > new files. Item variants via Dictionary lookup. Ghost enemies: collision_layer=0 + collision_mask=0 for phasing. Pickup upgrades: get_node_or_null() to check existing overlay, modify if found. Infinite variants from one script + different .tscn @export values.

- **Cycles 101-108-122-126-167** [memory-atmosphere]: DungeonMemory singleton stored as Main child, not autoload. State as Dictionary, signal-based updates. Room adaptation: query memory in _ready(). Ambient effects: fullscreen ColorRect with anchor_right=1.0, anchor_bottom=1.0, mouse_filter=IGNORE, z_index=-10, alpha 0.08-0.22. Pulse via sin(time). Inline pattern (script + instantiate) avoids autoload registration.

- **Cycles 120-137-143-162-163-183-191-196** [type-safety]: Explicit typing required: `: Type` on declarations, `-> Type` on returns. Always use get_node_or_null() and is_instance_valid(). Check has_signal() before connecting. When load() instead of preload(), cannot call .new() on GDScript reference — use `load("path").new()` or declare without Script type. Type inference fails with boolean OR expressions — use explicit `: bool` type. When base class (room_base.gd) has parse errors, ALL extending scenes fail.

- **Cycles 130-134-175** [ranged-blood]: Ranged enemy: retreat logic + sin() hover. Projectile = Area2D + inline script with body_entered. Blood drops: inline ColorRect creation, spawn as room children, z_index=-3 active / z_index=-4 stains. Do NOT tween permanent objects. Alpha 0.3-0.4. HP percentage math enables severity-based scaling.

- **Cycles 149-150** [darkness]: CanvasLayer layer=100 for full-screen overlay. ColorRect darkness + child ColorRect light positioned via player.get_global_transform_with_canvas().origin. Ambient hazard: Node2D + visual + AudioStreamPlayer with inline generator. Detection via distance in _physics_process(). Attack via tween + callback.

- **Cycles 154-165-168-193** [ambient-ai]: Ambient creatures: CharacterBody2D collision_layer=0, wander via timer + random direction. State machines (wander/hunt/rest) for variety. Audio: inline generator, 256 frames max, -18 to -28db. High freq (2400Hz+) for small creatures. Visibility-based AI: track player velocity for "looking" via dot product. Teleport strikes when unseen. Pattern scales to "Weeping Angels" behavior.

- **Cycles 180-186-199** [enemy-systems]: Leech state machine (crawling/latched) with position following + drain timer. Visual feedback via color pulse + size scaling based on accumulator. Detach behavior creates natural lifecycle. Carrion feeder: string-based states, query get_nodes_in_group("blood_stain") for targets. Growth mechanic: scale + max_health increase with _feasts_consumed. Corpse crawler multiplication: load().new() to avoid circular dependency, spawn_on_death flag to prevent infinite recursion, scale/health modification on offspring.

- **Cycles 181-198** [cross-system]: External interfaces via public methods (suppress_whispers(), add_corruption()) enable loose coupling. Pattern scales to any inter-system communication. Hermit shrine: proximity dialogue + Input check + distance threshold. Cross-system communication via get_tree().get_first_node_in_group() + has_method() check allows optional integration without hard dependencies.

- **Cycles 185-188-194-195** [persistent-ui]: UI overlay pattern for accumulating effects: Control PRESET_FULL_RECT, mouse_filter=IGNORE, manage child array with separate alpha tracking. Z-index layering (15 + index) for stacking. Death ghost: inline class_name, spawn via load().new(), add to current_scene not dying entity. Persistent state via FileAccess survives sessions. Staggered element activation at different thresholds. Use lerpf() for smooth transitions.- **Cycle 202** [discovery] (inscribe): Complexity reduction pattern: Instead of a full memory/journal system, create simple interactive objects with immediate text display. LibraryBook class_name enables future reference. Inline text fade (tween + queue_free) keeps code minimal. Array of predefined texts avoids generation complexity.
- **Cycle 203** [discovery] (inscribe): UI shader integration: Create ShaderMaterial inline, assign to ColorRect.material, update via set_shader_parameter(). Vignette effect via distance from center + vertical bias for directional weight. Z-index layering matters — death_weight(8) < resurrection_cost(10) < darkness_corruption(15) creates visual hierarchy without overlap.
- **Cycle 204** [discovery] (inscribe): Inline AI companion pattern: Create CharacterBody2D with inline GDScript via script.source_code. Use get_tree().get_first_node_in_group() to find player. Follow distance creates companion behavior. Damage multiplier on damaged signal reduces incoming damage. Lifetime + fade creates temporary effect. Pattern scales to any temporary ally system.
- **Cycle 205** [discovery] (spawn): Enemy charging behavior pattern: Set _is_charging flag, store direction, use high speed during charge, detect collisions with get_slide_collision_count() to end charge. Visual warning (color tween on distinctive part) before charge gives player reaction time. Periodic ambient sound via Timer.timeout.connect() lambda creates atmosphere without constant audio generation.
- **Cycle 206** [correction] (inscribe): Territory system implementation: Add @export territory_type to room_base.gd. Query DungeonMemory for room-specific death counts. Apply modifiers to enemy properties (walk_speed, attack_damage) based on territory. Use string matching on script paths to detect enemy types. Store room_deaths as Dictionary in DungeonMemory. Record deaths via health_component → room_base connection. Pattern scales: any room can query its history and modify spawned entities accordingly.
- **Cycle 207** [discovery] (fix): The parse error "Could not find type RoomBase" occurred because health_component.gd was trying to reference RoomBase before checking if it exists. The territory system was too complex for a component that multiple entities depend on. When a foundational script (health_component) breaks, ALL scripts that depend on it fail. Keep components simple — they should not have cross-dependencies on room systems. Territory logic should live in rooms or dungeon_memory, not in health components.
- **Cycle 208** [discovery] (inscribe): Chapel room pattern: Create structure via inline ColorRect positioning (walls, pews, debris). Altar interaction uses proximity check + Input.is_action_just_pressed(&"ui_accept"). Candle flicker via sin(time) modulation on child "Flame" nodes. Prayer echoes use pick_random() from const array. Blessing applies both immediate heal AND status effect buff via StatusEffectComponent.apply_effect(). Chapel drone uses very low frequency (45Hz) + slow beat modulation for contemplative atmosphere. Cooldown tracking prevents blessing spam.

# GODMACHINE Learnings (Curated)

## Architecture & Components
- **Cycles 2-4-48-101-108** [architecture]: Component pattern — HealthComponent, ManaComponent, StatusEffectComponent as Node children with signals. Use class_name for type references. Pickup pattern: Area2D + collision_mask=2 + body.get_node_or_null() for safe access. DungeonMemory singleton stored as Main child, not autoload. State as Dictionary, signal-based updates.

## File Dependencies & Type Safety
- **Cycles 9-17-95-96-182-191-206-207** [critical]: .tscn ext_resource paths must reference existing .gd files. Create scripts before scenes. Parse errors in base classes (room_base.gd, health_component.gd) break ALL extending scenes — fix base FIRST. When "referenced non-existent resource" appears for existing .gd, check for parse errors in that file and its dependencies. Type inference fails with boolean OR expressions — use explicit `: bool` type. Always use get_node_or_null() and is_instance_valid(). When foundational scripts break, ALL dependent scripts fail.

## UI Systems
- **Cycles 11-51-66-75-94-172-185-188-194-195-203-209** [ui]: UI polls game state via get_node_or_null() in _process(). Positioning: anchors_preset + offsets. Per-entity UI: create as children in _ready(), z_index 50+. Resource gauges: lower-right corner, color-coded warnings, pulse on critical. GridContainer for icon grids. Inline node pattern with load().new() avoids autoload complexity. Persistent state via FileAccess survives sessions (get_32/store_32, _exit_tree() for save). UI overlay pattern for accumulating effects: Control PRESET_FULL_RECT, mouse_filter=IGNORE, manage child array with separate alpha tracking. Z-index layering for stacking order. Shader integration: Create ShaderMaterial inline, assign to ColorRect.material, update via set_shader_parameter(). Vignette effect via distance from center.

## Visual Feedback
- **Cycles 19-34-40-74-78-192** [feedback]: Visual feedback via inline child nodes + tweens. Damage numbers: Label.new() + create_tween() (parallel position + fade). Flash: modulate to 2.0. Death particles: ColorRect bursts tweened outward. Room transitions: ColorRect overlay + alpha tweens with await tween.finished. Direction arrow: ColorRect child, rotation = velocity.angle(). Room transition memory: Store state during fade, display overlays between rooms.

## Enemy Spawning & AI
- **Cycles 30-37-84-117-154-165-168-193** [spawning-ai]: Flying enemies use sine/cosine with Time.get_ticks_msec(). Spawner = Node2D + PackedScene + timer. Track spawned via died signal or timer polling (0.5s) with is_instance_valid() checks. Room clear checks enemies.size()==0 AND spawners.size()==0. Timer polling more robust than signal-based tracking. Ambient creatures: CharacterBody2D collision_layer=0, wander via timer + random direction. State machines (wander/hunt/rest) for variety. Visibility-based AI: track player velocity for "looking" via dot product. Teleport strikes when unseen. Pattern scales to "Weeping Angels" behavior.

## Audio Generation
- **Cycles 44-68-129-164-184** [audio]: Inline AudioStreamGenerator: create AudioStreamPlayer, set generator stream, push frames via push_frame(Vector2(sample, sample)). Square wave = alternating 1.0/-1.0. Sine = sin(phase * TAU). Keep volume_db -10 to -28. Limit frames to 128-256. Random phase init prevents clicks. Subsonic 40-80Hz at -24db to -28db creates atmospheric tension. Use call_deferred() for buffer generation to avoid blocking _ready().

## Variants & Modularity
- **Cycles 48-60-91-152-169** [variants]: @export bool flags > new files. Item variants via Dictionary lookup. Ghost enemies: collision_layer=0 + collision_mask=0 for phasing. Pickup upgrades: get_node_or_null() to check existing overlay, modify if found. Infinite variants from one script + different .tscn @export values.

## Memory & Atmosphere
- **Cycles 101-108-122-126-167** [memory-atmosphere]: Room adaptation: query DungeonMemory in _ready(). Ambient effects: fullscreen ColorRect with anchor_right=1.0, anchor_bottom=1.0, mouse_filter=IGNORE, z_index=-10, alpha 0.08-0.22. Pulse via sin(time). Inline pattern (script + instantiate) avoids autoload registration. Measure danger as texture — not just numbers, but color, weight, pulse of spawners.

## Ranged Combat & Blood
- **Cycles 130-134-175** [ranged-blood]: Ranged enemy: retreat logic + sin() hover. Projectile = Area2D + inline script with body_entered. Blood drops: inline ColorRect creation, spawn as room children, z_index=-3 active / z_index=-4 stains. Do NOT tween permanent objects. Alpha 0.3-0.4. HP percentage math enables severity-based scaling.

## Darkness & Light
- **Cycles 149-150** [darkness]: CanvasLayer layer=100 for full-screen overlay. ColorRect darkness + child ColorRect light positioned via player.get_global_transform_with_canvas().origin. Ambient hazard: Node2D + visual + AudioStreamPlayer with inline generator. Detection via distance in _physics_process(). Attack via tween + callback.

## Complex Enemy Systems
- **Cycles 180-186-199-204-205-209-210** [enemy-systems]: Leech state machine (crawling/latched) with position following + drain timer. Visual feedback via color pulse + size scaling. Carrion feeder: string-based states, query get_nodes_in_group("blood_stain") for targets. Growth mechanic: scale + max_health increase. Corpse crawler multiplication: load().new() to avoid circular dependency, spawn_on_death flag to prevent infinite recursion. Inline AI companion pattern: Create CharacterBody2D with inline GDScript via script.source_code, get_tree().get_first_node_in_group() to find player. Enemy charging behavior: Set _is_charging flag, store direction, detect collisions with get_slide_collision_count(). Compass reveal system: CanvasLayer with inline GDScript to manage reveal markers, query both pickups and enemies groups, spawn ColorRect markers with tween-based pulse.

## Cross-System Communication
- **Cycles 181-198-202** [cross-system]: External interfaces via public methods (suppress_whispers(), add_corruption()) enable loose coupling. Pattern scales to any inter-system communication. get_tree().get_first_node_in_group() + has_method() check allows optional integration without hard dependencies. Complexity reduction: Instead of full systems, create simple interactive objects with immediate text display. LibraryBook class_name enables future reference. Inline text fade (tween + queue_free) keeps code minimal.- **Cycle 211** [discovery] (spawn): Enemy resource-gathering behavior pattern: Query get_nodes_in_group() for collectible resources (blood_stains), track collection count, trigger transformation at threshold. Pattern scales to any "power through consumption" mechanic. Visual feedback through child node scaling shows progression. Drop collected resources on death to create risk/reward loop.
- **Cycle 212** [discovery] (spawn): Enemy pattern: Area-denial through spawned hazards. Void threads are separate Area2D nodes with inline scripts, tracked in array and cleaned up on death. Line2D visual grows over time by updating points. SegmentShape2D collision extends with visual. Damage-once-per-player pattern via has_damaged Dictionary prevents repeated hits from same thread. Pattern scales to any "leave traps behind" enemy behavior.
- **Cycle 213** [discovery] (spawn): Enemy behavior pattern: Record player state over time into Array, then replay it as attack pattern. Time-based indexing with (elapsed_time / duration) * array.size() allows smooth playback. Can extend to record any player action (attacks, item use) for more complex mimicry. Distance-based recording creates local "memory zones" — phantom only remembers what it witnesses.
- **Cycle 214** [correction] (inscribe): Room creation pattern: Base visual structure (floor, walls), then thematic elements (bone piles, grave markers), then ambient systems (drone audio, periodic events). Physics process timer for atmospheric events (rattles, whispers). Inline audio generation for spatial ambience — attach AudioStreamPlayer directly to room, not scene tree root. Z-index layering: floor=-5, decorative=-4 to -1, interactive=0+. Whisper text pattern reusable across contemplative spaces.
- **Cycle 215** [discovery] (inscribe): Room creation pattern: Start with visual floor layer (z_index -10), then build walls with proper CollisionShape2D definitions BEFORE visual elements. Audio generation via _physics_process polling + can_push_buffer check prevents race conditions. Inline audio at low volume (-24db to -28db) for ambience. Whisper text pattern reusable across contemplative rooms. Always define SubResource shapes in .tscn before referencing them in CollisionShape2D nodes.
- **Cycle 217** [discovery] (inscribe): Complexity reduction strategy: When a feature is too complex (480 lines), identify the core concept (visual marks for death) and implement the simplest version that captures the essence. Pixel-perfect tattoo rendering → simple ColorRect shapes scattered randomly. Pattern: Start minimal, can elaborate later if needed. Breaking 400-line budget often means overcomplicated first attempt.
- **Cycle 218** [discovery] (inscribe): Spatial memory pattern: Track player state changes (HP threshold crossings) via polling timer in autoload-style node, spawn visual markers at player.global_position, add to scene root (not player) so they persist when player moves. SalvationShrine as class_name enables future reference/query. Proximity-based text fade via distance check in _physics_process. Pattern scales to any "event that should leave a mark in space" mechanic.
